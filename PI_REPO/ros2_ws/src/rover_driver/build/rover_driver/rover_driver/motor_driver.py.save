import rclpy
from rclpy.node import Node
from geometry_msgs.msg import Twist
import serial

class MotorDriver(Node):
    def __init__(self):
        super().__init__('motor_driver')
        self.subscription = self.create_subscription(
            Twist, '/cmd_vel', self.listener_callback, 10)
        self.serial = serial.Serial('/dev/ttyACM0', 115200, timeout=1)
        self.get_logger().info('✅ MotorDriver started (ACTION-#### format)')

        self.last_command = "S-0\n"
        self.timer = self.create_timer(0.1, self.send_last_command)

    def listener_callback(self, msg: Twist):
        # Joystick input
        linear_x = msg.linear.x    # frem/bak
        linear_y = -msg.linear.y   # sideveis (snudd: høyre = R)
        angular = msg.angular.z    # rotasjon (twist)

        scale = 3000
        speed_x = int(abs(linear_x) * scale)
        speed_y = int(abs(linear_y) * scale)
        speed_ang = int(abs(angular) * scale)

        command = "S-0\n"

        # --- diagonaler ---
        if abs(linear_x) > 0.2 and abs(linear_y) > 0.2:
            if linear_x > 0 and linear_y > 0:
                command = f"FR-{min(speed_x, speed_y)}\n"
            elif linear_x > 0 and linear_y < 0:
                command = f"FL-{min(speed_x, speed_y)}\n"
            elif linear_x < 0 and linear_y > 0:
                command = f"BR-{min(speed_x, speed_y)}\n"
            elif linear_x < 0 and linear_y < 0:
                command = f"BL-{min(speed_x, speed_y)}\n"

        # --- enkle retninger ---
        elif abs(linear_x) > 0.2:
            if linear_x > 0:
                command = f"F-{speed_x}\n"
            else:
                command = f"B-{speed_x}\n"
        elif abs(linear_y) > 0.2:
            if linear_y > 0:
                command = f"R-{speed_y}\n"
            else:
                command = f"L-{speed_y}\n"

        # --- rotasjon ---
        elif abs(angular) > 0.2:
            if angular > 0:
                command = f"CCW-{speed_ang}\n"   # venstre twist
            else:
                command = f"CW-{speed_ang}\n"    # høyre twist

        self.last_command = command

        self.get_logger().info(
            f"Joystick: x={linear_x:.2f}, y={linear_y:.2f}, z={angular:.2f} → Sent: {command.strip()}"
        )

    def send_last_command(self):
        self.serial.write(self.last_command.encode())

def main(args=None):
    rclp
